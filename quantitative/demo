# -*- coding: utf-8 -*-
"""
å¤šå› å­ETFè½®åŠ¨ç­–ç•¥å›æµ‹
ä½œè€…ï¼šQwen
ç­–ç•¥è§„åˆ™ï¼š
  ä¹°å…¥ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
    1. å‘¨MA20 > æœˆMA12
    2. æ—¥MA20 ä¸Šç©¿ å‘¨MA20
    3. MACDé‡‘å‰ + çº¢æŸ±æ”¾å¤§ + DIF>0
    4. æˆäº¤é‡ > 20æ—¥å‡é‡
  å–å‡ºï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
    1. å‘¨MA20 < æœˆMA12
    2. æ—¥MA20 ä¸‹ç©¿ å‘¨MA20
    3. MACDæ­»å‰ + ç»¿æŸ±æ”¾å¤§ + DIF<0
    4. æˆäº¤é‡ > 20æ—¥å‡é‡
"""

import akshare as ak
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from ta.trend import macd, macd_signal, macd_diff
import warnings
warnings.filterwarnings('ignore')

# ========== å‚æ•°é…ç½® ==========
ETF_LIST = [
    "515790"
]
ETF_NAMES = {
    "515790": "å…‰ä¼ETF"
}
START_DATE = "20180101"
END_DATE = "20260131"
INITIAL_CAPITAL = 1_000_000  # 100ä¸‡å…ƒ
COMMISSION = 0.0003  # 0.03%

# ========== æ•°æ®è·å–ä¸é¢„å¤„ç† ==========
def get_etf_data(symbol):
    try:
        df = ak.fund_etf_hist_sina(symbol=f"sz{symbol}" if symbol[0] in ['0','1'] else f"sh{symbol}")
    except:
        try:
            df = ak.fund_etf_hist_sina(symbol=f"sh{symbol}")
        except:
            print(f"âŒ æ— æ³•è·å– {symbol} æ•°æ®")
            return None
    df['date'] = pd.to_datetime(df['date'])
    df = df[(df['date'] >= START_DATE) & (df['date'] <= END_DATE)].copy()
    df.sort_values('date', inplace=True)
    df.reset_index(drop=True, inplace=True)
    return df[['date', 'open', 'high', 'low', 'close', 'volume']]

# ========== è®¡ç®—æŒ‡æ ‡ ==========
def calculate_indicators(df):
    # æ—¥çº¿æŒ‡æ ‡
    df['ma20'] = df['close'].rolling(20).mean()
    df['vol_ma20'] = df['volume'].rolling(20).mean()

    # MACD (12,26,9)
    df['macd'] = macd(df['close'])
    df['macd_signal'] = macd_signal(df['close'])
    df['macd_hist'] = df['macd'] - df['macd_signal']

    # å‘¨çº¿ & æœˆçº¿æ•°æ®ï¼ˆé€šè¿‡é‡é‡‡æ ·ï¼‰
    weekly = df.set_index('date').resample('W-FRI').last()
    monthly = df.set_index('date').resample('ME').last()

    weekly['w_ma20'] = weekly['close'].rolling(20).mean()
    monthly['m_ma12'] = monthly['close'].rolling(12).mean()

    # æ˜ å°„å›æ—¥çº¿
    df.set_index('date', inplace=True)
    df['w_ma20'] = np.nan
    df['m_ma12'] = np.nan

    for idx in weekly.index:
        if idx in df.index:
            df.at[idx, 'w_ma20'] = weekly.at[idx, 'w_ma20']
    for idx in monthly.index:
        if idx in df.index:
            df.at[idx, 'm_ma12'] = monthly.at[idx, 'm_ma12']

    df.ffill(inplace=True)
    df.reset_index(inplace=True)

    return df

# ========== ç”Ÿæˆä¿¡å· ==========
def generate_signals(df):
    df = df.copy()
    df['buy_signal'] = False
    df['sell_signal'] = False

    for i in range(2, len(df)):
        # ä¹°å…¥æ¡ä»¶
        buy_cond1 = df['w_ma20'].iloc[i] > df['m_ma12'].iloc[i]
        buy_cond2 = (df['ma20'].iloc[i] > df['w_ma20'].iloc[i]) and (df['ma20'].iloc[i-1] <= df['w_ma20'].iloc[i-1])
        buy_cond3 = (
                (df['macd'].iloc[i] > df['macd_signal'].iloc[i]) and
                (df['macd'].iloc[i-1] <= df['macd_signal'].iloc[i-1]) and
                (df['macd_hist'].iloc[i] > df['macd_hist'].iloc[i-1]) and
                (df['macd'].iloc[i] > 0)
        )
        buy_cond4 = df['volume'].iloc[i] > df['vol_ma20'].iloc[i]

        # å–å‡ºæ¡ä»¶
        sell_cond1 = df['w_ma20'].iloc[i] < df['m_ma12'].iloc[i]
        sell_cond2 = (df['ma20'].iloc[i] < df['w_ma20'].iloc[i]) and (df['ma20'].iloc[i-1] >= df['w_ma20'].iloc[i-1])
        sell_cond3 = (
                (df['macd'].iloc[i] < df['macd_signal'].iloc[i]) and
                (df['macd'].iloc[i-1] >= df['macd_signal'].iloc[i-1]) and
                (df['macd_hist'].iloc[i] < df['macd_hist'].iloc[i-1]) and
                (df['macd'].iloc[i] < 0)
        )
        sell_cond4 = df['volume'].iloc[i] > df['vol_ma20'].iloc[i]

        df.loc[i, 'buy_signal'] = buy_cond1 and buy_cond2 and buy_cond3 and buy_cond4
        df.loc[i, 'sell_signal'] = sell_cond1 and sell_cond2 and sell_cond3 and sell_cond4

    return df

# ========== ä¸»å›æµ‹å¼•æ“ ==========
def backtest():
    all_data = {}
    signals = {}

    # è·å–å¹¶å¤„ç†æ¯åªETFæ•°æ®
    for symbol in ETF_LIST:
        print(f"æ­£åœ¨å¤„ç† {symbol} - {ETF_NAMES[symbol]}")
        df = get_etf_data(symbol)
        print(f"æ•°æ®è·å–å®Œæˆï¼Œæ•°æ®é•¿åº¦ä¸º {len(df)}")
        if df is None or len(df) < 100:
            continue
        df = calculate_indicators(df)
        df = generate_signals(df)
        all_data[symbol] = df
        signals[symbol] = df[['date', 'buy_signal', 'sell_signal']].copy()

    print(f"æ•°æ®å¤„ç†å®Œæˆ{all_data}")

    # ç»„åˆå›æµ‹
    dates = pd.date_range(start=START_DATE, end=END_DATE, freq='D')
    portfolio = pd.DataFrame(index=dates, columns=['equity', 'holdings', 'cash'])
    portfolio['equity'] = INITIAL_CAPITAL
    portfolio['cash'] = INITIAL_CAPITAL
    portfolio['holdings'] = 0

    current_holdings = {}  # {symbol: shares}
    trade_log = []

    for date in dates:
        if date not in portfolio.index:
            continue

        # æ£€æŸ¥å½“æ—¥æ˜¯å¦æœ‰ETFå‘å‡ºä¿¡å·
        buy_list = []
        sell_list = []

        for symbol in all_data:
            df = all_data[symbol]
            if date in df['date'].values:
                row = df[df['date'] == date].iloc[0]
                if row['buy_signal']:
                    buy_list.append(symbol)
                if row['sell_signal'] and symbol in current_holdings:
                    sell_list.append(symbol)

        # å…ˆå¤„ç†å–å‡º
        for symbol in sell_list:
            df = all_data[symbol]
            price = df[df['date'] == date]['close'].values[0]
            shares = current_holdings[symbol]
            amount = shares * price * (1 - COMMISSION)
            portfolio.loc[date, 'cash'] += amount
            del current_holdings[symbol]
            trade_log.append({
                'date': date, 'symbol': symbol, 'action': 'SELL',
                'price': price, 'shares': shares, 'amount': amount
            })

        # å†å¤„ç†ä¹°å…¥ï¼ˆç”¨å½“å‰ç°é‡‘ç­‰åˆ†ï¼‰
        if buy_list:
            available_cash = portfolio.loc[date, 'cash']
            per_cash = available_cash / len(buy_list)
            for symbol in buy_list:
                df = all_data[symbol]
                price = df[df['date'] == date]['close'].values[0]
                shares = int((per_cash * (1 - COMMISSION)) // (price * 100)) * 100  # ä»¥100ä»½ä¸ºå•ä½
                if shares > 0:
                    cost = shares * price * (1 + COMMISSION)
                    portfolio.loc[date, 'cash'] -= cost
                    current_holdings[symbol] = shares
                    trade_log.append({
                        'date': date, 'symbol': symbol, 'action': 'BUY',
                        'price': price, 'shares': shares, 'amount': cost
                    })

        # è®¡ç®—å½“æ—¥æŒä»“å¸‚å€¼
        holding_value = 0
        for symbol, shares in current_holdings.items():
            df = all_data[symbol]
            if date in df['date'].values:
                price = df[df['date'] == date]['close'].values[0]
                holding_value += shares * price
        portfolio.loc[date, 'holdings'] = holding_value
        portfolio.loc[date, 'equity'] = portfolio.loc[date, 'cash'] + holding_value

    # å‰å‘å¡«å…… equityï¼ˆéäº¤æ˜“æ—¥ï¼‰
    portfolio['equity'].ffill(inplace=True)
    portfolio.dropna(inplace=True)

    return portfolio, trade_log, all_data

# ========== ç»©æ•ˆè®¡ç®— ==========
def calculate_performance(portfolio, trade_log):
    returns = portfolio['equity'].pct_change().dropna()
    total_return = (portfolio['equity'].iloc[-1] / INITIAL_CAPITAL) - 1
    annualized_return = (1 + total_return) ** (252 / len(portfolio)) - 1

    # æœ€å¤§å›æ’¤
    cum_max = portfolio['equity'].cummax()
    drawdown = (portfolio['equity'] - cum_max) / cum_max
    max_drawdown = drawdown.min()

    # èƒœç‡
    profits = []
    for i in range(1, len(trade_log), 2):
        if trade_log[i]['action'] == 'SELL' and trade_log[i-1]['action'] == 'BUY':
            buy_amount = trade_log[i-1]['amount']
            sell_amount = trade_log[i]['amount']
            profit = sell_amount - buy_amount
            profits.append(profit)
    win_rate = np.mean(np.array(profits) > 0) if profits else 0

    # èµ„é‡‘åˆ©ç”¨ç‡
    holding_days = (portfolio['holdings'] > 0).sum()
    total_days = len(portfolio)
    capital_utilization = holding_days / total_days

    return {
        'æ€»æ”¶ç›Šç‡': f"{total_return:.2%}",
        'å¹´åŒ–æ”¶ç›Šç‡': f"{annualized_return:.2%}",
        'æœ€å¤§å›æ’¤': f"{max_drawdown:.2%}",
        'èƒœç‡': f"{win_rate:.1%}",
        'èµ„é‡‘åˆ©ç”¨ç‡': f"{capital_utilization:.1%}",
        'æœŸæœ«å‡€å€¼': f"Â¥{portfolio['equity'].iloc[-1]:,.0f}"
    }

# ========== ç»˜å›¾ï¼ˆä»¥512400ä¸ºä¾‹ï¼‰==========
def plot_signals(etf_data, symbol):
    df = etf_data[symbol].copy()
    df.set_index('date', inplace=True)

    plt.figure(figsize=(14, 7))
    plt.plot(df.index, df['close'], label='æ”¶ç›˜ä»·', color='black', linewidth=1)
    plt.plot(df.index, df['ma20'], label='æ—¥MA20', color='orange')
    plt.plot(df.index, df['w_ma20'], label='å‘¨MA20', color='blue')
    plt.plot(df.index, df['m_ma12'], label='æœˆMA12', color='purple')

    # æ ‡è®°ä¹°å–ç‚¹
    buy_points = df[df['buy_signal']]
    sell_points = df[df['sell_signal']]
    plt.scatter(buy_points.index, buy_points['close'], marker='^', color='red', s=100, label='ä¹°å…¥')
    plt.scatter(sell_points.index, sell_points['close'], marker='v', color='green', s=100, label='å–å‡º')

    plt.title(f"{symbol} - {ETF_NAMES[symbol]} ä¹°å–ä¿¡å·")
    plt.legend()
    plt.grid(True, linestyle='--', alpha=0.5)
    plt.gca().xaxis.set_major_locator(mdates.YearLocator())
    plt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%Y'))
    plt.tight_layout()
    plt.savefig(f"{symbol}_signals.png", dpi=150)
    plt.show()

# ========== ä¸»ç¨‹åº ==========
if __name__ == "__main__":
    print("ğŸš€ å¼€å§‹å›æµ‹...")
    portfolio, trade_log, etf_data = backtest()
    perf = calculate_performance(portfolio, trade_log)

    print("\nğŸ“Š ç­–ç•¥ç»©æ•ˆ:")
    for k, v in perf.items():
        print(f"  {k}: {v}")

    print(f"\nğŸ“ˆ æ€»äº¤æ˜“æ¬¡æ•°: {len(trade_log)}")

    # ç»˜åˆ¶å‡€å€¼æ›²çº¿
    plt.figure(figsize=(12, 6))
    plt.plot(portfolio.index, portfolio['equity'], label='ç­–ç•¥å‡€å€¼', color='blue')
    plt.title('ç­–ç•¥å‡€å€¼æ›²çº¿ (2018â€“2026)')
    plt.ylabel('å‡€å€¼ (å…ƒ)')
    plt.grid(True, linestyle='--', alpha=0.5)
    plt.legend()
    plt.tight_layout()
    plt.savefig("strategy_equity_curve.png", dpi=150)
    plt.show()

    # ç»˜åˆ¶å‰3åªETFçš„ä¿¡å·å›¾
    for symbol in ETF_LIST[:1]:
        if symbol in etf_data:
            plot_signals(etf_data, symbol)

    print("\nâœ… å›æµ‹å®Œæˆï¼ä¿¡å·å›¾å·²ä¿å­˜ä¸º PNG æ–‡ä»¶ã€‚")
